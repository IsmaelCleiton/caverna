---
import RepoList from "./RepoList.astro";
const { repos: initialRepos = [] } = Astro.props;
const containerId = `repo-list-${Math.random().toString(36).slice(2, 8)}`;
---

<div id={containerId} class="repo-list-wrapper">
    {
        initialRepos.length ? (
            <RepoList repos={initialRepos} />
        ) : (
            <p>Não foi possível carregar os repositórios.</p>
        )
    }
</div>

<script is:inline>
    const CACHE_KEY = "github_repos";
    const TS_KEY = "github_repos_ts";
    const FIFTEEN_MIN = 15 * 60 * 1000;

    function renderRepos(repos) {
        const ul = document.createElement("ul");
        ul.className = "repo-list";
        repos.forEach((repo) => {
            const li = document.createElement("li");
            li.innerHTML = `
        <div class=\"repo-tile\">  
          <div class=\"repo-title\">   
            <h3>
              <a href=\"${repo.html_url}\" target=\"_blank\" rel=\"noopener noreferrer\">${repo.name}</a>
            </h3>
            ${repo.language ? `<small>${repo.language}</small>` : ""}
          </div>
          ${repo.description ? `<p class=\"description\">${repo.description}</p>` : ""}
          <small class=\"updated\">
            Atualizado em: ${new Date(repo.updated_at).toLocaleDateString(
                "pt-BR",
                {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                },
            )}
          </small>
        </div>
      `;
            ul.appendChild(li);
        });
        return ul;
    }

    function updateDom(repos) {
        const root = document.getElementById("${containerId}");
        if (!root) return;
        root.innerHTML = "";
        if (repos && repos.length) {
            root.appendChild(renderRepos(repos));
        } else {
            root.innerHTML =
                "<p>Não foi possível carregar os repositórios.</p>";
        }
    }

    async function fetchAndCache() {
        try {
            const resp = await fetch(
                "https://api.github.com/users/IsmaelCleiton/repos?sort=updated&per_page=100",
            );
            if (resp.ok) {
                const data = await resp.json();
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(TS_KEY, Date.now().toString());
                updateDom(data);
            } else {
                console.error("erro fetch github direto", resp.statusText);
            }
        } catch (err) {
            console.error("erro fetch github", err.message || err);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const cached = localStorage.getItem(CACHE_KEY);
        const ts = localStorage.getItem(TS_KEY);
        if (cached && ts && Date.now() - parseInt(ts, 10) < FIFTEEN_MIN) {
            try {
                updateDom(JSON.parse(cached));
            } catch {}
        } else {
            fetchAndCache();
        }
    });
</script>

<style is:global>
    .repo-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .repo-list li {
        margin-bottom: 1rem;
        background-color: #f0f0f000;
    }

    .repo-tile {
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
        border-left: 3px solid #333;
        background-color: #f0f0f000;
        transition: all 0.3s ease;
    }

    .repo-tile:hover {
        background: rgba(0, 0, 0, 0.05);
        transform: translateX(2px);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .repo-title {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .repo-list a {
        text-decoration: none;
        color: inherit;
        flex: 1;
    }

    .repo-list h3 {
        font-weight: 500;
        margin: 0;
        color: #333;
        font-size: 1.1rem;
        transition: color 0.2s;
    }

    .repo-list a:hover {
        color: #000000;
        font-weight: bold;
        text-decoration: underline;
    }

    .repo-list small {
        color: #999;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .description {
        margin: 0;
        color: #555;
        line-height: 1.5;
        font-size: 0.95rem;
    }

    .updated {
        margin-top: 0.5rem;
    }
</style>
